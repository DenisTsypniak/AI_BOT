{% extends "base.html" %}

{% block title %}Таблиця: {{ table_name }} - Live Role Bot{% endblock %}

{% block content %}
<style>
    .schema-table-page {
        display: grid;
        gap: 16px;
    }
    .schema-header-name {
        font-family: "Cascadia Mono", "Cascadia Code", Consolas, monospace;
        font-size: 1.8rem;
        color: var(--accent);
        letter-spacing: -.01em;
    }
    .schema-grid {
        display: grid;
        gap: 16px;
    }
    .schema-value-code {
        font-family: "Cascadia Mono", "Cascadia Code", Consolas, monospace;
    }
    @media (max-width: 900px) {
        .schema-header-name { font-size: 1.35rem; }
    }
</style>

<div class="schema-table-page">
    <section class="page-header">
        <div class="split">
            <div>
                <div class="schema-header-name">{{ table_name }}</div>
                <p class="page-description">Перегляд структури та рядків таблиці. Показані колонки, типи, nullable/default та дані з пагінацією.</p>
            </div>
            <div class="actions-inline">
                <a href="/schema" class="btn">← Назад до схеми</a>
                <a href="/schema/{{ table_name }}/csv" class="btn primary">⬇ Export CSV</a>
            </div>
        </div>
    </section>

    <section class="card stack-sm">
        <div class="split">
            <div>
                <h2 class="section-title">Структура (колонки)</h2>
                <p class="section-subtitle">Схема таблиці з основними властивостями полів.</p>
            </div>
            <span class="pill">Колонок <strong>{{ columns|length }}</strong></span>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Назва</th>
                        <th>Тип</th>
                        <th>Nullable</th>
                        <th>За замовчуванням</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in columns %}
                    <tr>
                        <td class="schema-value-code" style="font-weight:700;">{{ col.column_name }}</td>
                        <td style="color: var(--accent);">{{ col.data_type }}</td>
                        <td>
                            {% if col.is_nullable == 'YES' %}
                            <span class="badge">Так</span>
                            {% else %}
                            <span class="badge green">Ні</span>
                            {% endif %}
                        </td>
                        <td class="schema-value-code text-muted">{{ col.column_default or 'NULL' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <section class="card stack-sm">
        <div class="split">
            <div>
                <h2 class="section-title">Дані (рядки {{ (offset + 1) if rows else 0 }} - {{ offset + rows|length }})</h2>
                <p class="section-subtitle">Поточна сторінка даних таблиці з обрізанням довгих значень для зручного перегляду.</p>
            </div>
            <span class="pill">Ліміт <strong>{{ limit }}</strong></span>
        </div>

        <div class="table-container">
            <table style="white-space: nowrap;">
                <thead>
                    <tr>
                        {% for col in columns %}
                        <th>{{ col.column_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                    <tr>
                        {% for col, val in row.items() %}
                        {% if loop.index0 == 0 and col.endswith('_id') %}
                        <td class="schema-value-code" style="color: var(--accent);">
                            {{ val }}
                            {% if validation_route_exists %}
                                {% if table_name == 'users' %}
                                <a href="{{ route_prefix }}/{{ row.get('guild_id', '') }}/{{ val }}" class="btn" style="padding: 4px 8px; font-size: 0.72rem; margin-left: 8px;">Дет.</a>
                                {% else %}
                                <a href="{{ route_prefix }}/{{ val }}" class="btn" style="padding: 4px 8px; font-size: 0.72rem; margin-left: 8px;">Дет.</a>
                                {% endif %}
                            {% endif %}
                        </td>
                        {% elif val is none %}
                        <td class="text-muted" style="font-style: italic;">NULL</td>
                        {% elif 'time' in col or 'date' in col or 'created_at' in col or 'updated_at' in col %}
                        <td class="text-muted" style="font-size: 0.84rem;">{{ val|kyiv_time('%Y-%m-%d %H:%M:%S', default=val) }}</td>
                        {% elif val is string and (val.startswith('{') or val.startswith('[')) %}
                        <td>
                            <pre style="margin:0; max-height: 200px; font-size:.8rem;">{{ val|json_pretty }}</pre>
                        </td>
                        {% elif val is string and val|length > 60 %}
                        <td title="{{ val }}">{{ val[:57] }}...</td>
                        {% else %}
                        <td style="max-width: 320px; overflow: hidden; text-overflow: ellipsis;" title="{{ val }}">{{ val }}</td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="{{ columns|length }}"><div class="empty-state">Даних немає.</div></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    <div class="pagination">
        {% set prev_offset = offset - limit %}
        {% set next_offset = offset + limit %}

        {% if offset > 0 %}
        <a href="/schema/{{ table_name }}?limit={{ limit }}&offset={{ prev_offset }}" class="btn">← Попередня</a>
        {% else %}
        <button class="btn" disabled>← Попередня</button>
        {% endif %}

        {% if rows|length == limit %}
        <a href="/schema/{{ table_name }}?limit={{ limit }}&offset={{ next_offset }}" class="btn">Наступна →</a>
        {% else %}
        <button class="btn" disabled>Наступна →</button>
        {% endif %}
    </div>
</div>
{% endblock %}

