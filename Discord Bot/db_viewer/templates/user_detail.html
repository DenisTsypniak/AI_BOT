{% extends "base.html" %}

{% block title %}–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {{ data.user.discord_username or user_id }} - Live Role Bot{% endblock %}

{% block content %}
<style>
    .user-detail-grid {
        display: grid;
        grid-template-columns: 1.08fr .92fr;
        gap: 18px;
        align-items: start;
    }
    .user-meta {
        display: grid;
        gap: 12px;
    }
    .user-header-line {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
    }
    .user-header-line .handle {
        color: var(--text-muted);
        font-size: .95rem;
    }
    .user-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    .user-actions form { margin: 0; }
    .scroll-box {
        max-height: 460px;
        overflow: auto;
    }
    .scroll-box::-webkit-scrollbar { width: 10px; }
    .scroll-box::-webkit-scrollbar-thumb {
        background: rgba(148,163,184,.2);
        border-radius: 999px;
        border: 2px solid transparent;
        background-clip: padding-box;
    }
    .fact-key {
        font-family: "Cascadia Mono", "Cascadia Code", Consolas, monospace;
        color: var(--accent);
        font-size: .84rem;
        word-break: break-word;
    }
    .fact-value-cell {
        max-width: 360px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .msg-role-badge {
        text-transform: uppercase;
        letter-spacing: .05em;
        font-size: .68rem;
    }
    .msg-role-badge.user { background: rgba(79,141,255,.14) !important; border-color: rgba(79,141,255,.26) !important; color: #b7d2ff !important; }
    .msg-role-badge.assistant { background: rgba(16,185,129,.14) !important; border-color: rgba(16,185,129,.24) !important; color: #8ff0cc !important; }
    .msg-role-badge.system { background: rgba(245,158,11,.14) !important; border-color: rgba(245,158,11,.24) !important; color: #ffd88a !important; }
    @media (max-width: 1100px) {
        .user-detail-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="stack">
    <section class="page-header">
        <div class="split">
            <div class="user-meta">
                <div class="user-header-line">
                    <h1 class="page-title" style="margin:0;">{{ data.user.discord_username or '–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á' }}</h1>
                    <span class="handle">({{ data.user.combined_label }})</span>
                </div>
                <p class="page-description">Guild ID: <span class="mono">{{ guild_id }}</span> | User ID: <span class="mono">{{ user_id }}</span></p>
                <div class="chip-row">
                    <span class="pill">–§–∞–∫—Ç—ñ–≤ <strong>{{ data.facts|length }}</strong></span>
                    <span class="pill">–í–ø–µ—Ä—à–µ <strong>{{ data.user.first_seen|kyiv_time('%Y-%m-%d %H:%M') }}</strong></span>
                    <span class="pill">–û–Ω–æ–≤–ª–µ–Ω–æ <strong>{{ data.user.updated_at|kyiv_time('%Y-%m-%d %H:%M') }}</strong></span>
                </div>
            </div>

            <div class="user-actions">
                <a href="/users" class="btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ —Å–ø–∏—Å–∫—É</a>
                <form action="/users/{{ guild_id }}/{{ user_id }}/delete" method="POST"
                      onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ {{ data.user.discord_username or user_id }}?');">
                    <button type="submit" class="btn" style="background-color: rgba(239,68,68,.16); border-color: rgba(239,68,68,.28); color:#ffd2d2;">–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</button>
                </form>
            </div>
        </div>
    </section>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">–í–ø–µ—Ä—à–µ –ø–æ–±–∞—á–µ–Ω–∏–π</div>
            <div class="stat-value" style="font-size:1.35rem;">{{ data.user.first_seen|kyiv_time('%Y-%m-%d %H:%M') }}</div>
            <div class="stat-subtitle">–ø–µ—Ä—à–∏–π —Å–ª—ñ–¥ —É –±–∞–∑—ñ</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</div>
            <div class="stat-value" style="font-size:1.35rem;">{{ data.user.updated_at|kyiv_time('%Y-%m-%d %H:%M') }}</div>
            <div class="stat-subtitle">–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å/–ø–∞–º'—è—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–∫—Ç—ñ–≤</div>
            <div class="stat-value" style="color: var(--success);">{{ data.facts|length }}</div>
            <div class="stat-subtitle">—É –∫–∞—Ä—Ç—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</div>
        </div>
    </div>

    <div class="user-detail-grid">
        <section class="card stack-sm">
            <div>
                <h2 class="section-title">üß† –í—ñ–¥–æ–º—ñ —Ñ–∞–∫—Ç–∏</h2>
                <p class="section-subtitle">–ó–±–µ—Ä–µ–∂–µ–Ω—ñ —Ñ–∞–∫—Ç–∏, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤ –ø–∞–º'—è—Ç—ñ —Ç–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –±–æ—Ç–∞.</p>
            </div>
            <div class="table-container scroll-box">
                <table>
                    <thead>
                        <tr>
                            <th>–ö–ª—é—á</th>
                            <th>–ó–Ω–∞—á–µ–Ω–Ω—è</th>
                            <th>–í–∞–∂–ª–∏–≤—ñ—Å—Ç—å</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fact in data.facts %}
                        <tr>
                            <td><div class="fact-key">{{ fact.fact_key }}</div></td>
                            <td class="fact-value fact-value-cell" title="{{ fact.fact_value }}">{{ fact.fact_value }}</td>
                            <td class="mono" style="color: var(--accent); font-weight:700;">{{ fact.importance }}</td>
                            <td>
                                <form action="/users/{{ guild_id }}/{{ user_id }}/facts/{{ fact.fact_id }}/delete"
                                      method="POST"
                                      onsubmit="return confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–∫—Ç `{{ fact.fact_key }}`?');">
                                    <button type="submit" class="btn" style="padding: 5px 8px; font-size: .78rem; background-color: rgba(239,68,68,.14); border-color: rgba(239,68,68,.24); color:#ffd2d2;">–í–∏–¥.</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4">
                                <div class="empty-state">–£ –∫–∞—Ä—Ç—Ü—ñ —â–µ –Ω–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö —Ñ–∞–∫—Ç—ñ–≤.</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>

        <section class="card stack-sm">
            <div>
                <h2 class="section-title">üïò –û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h2>
                <p class="section-subtitle">–®–≤–∏–¥–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–æ–∑–º–æ–≤–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –ø–µ—Ä–µ—Ö–æ–¥–æ–º —É –ø–æ–≤–Ω—ñ –¥–µ—Ç–∞–ª—ñ.</p>
            </div>
            <div class="table-container scroll-box">
                <table>
                    <thead>
                        <tr>
                            <th>–ß–∞—Å</th>
                            <th>–†–æ–ª—å</th>
                            <th>–¢–µ–∫—Å—Ç</th>
                            <th>–î—ñ—ó</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for msg in data.messages %}
                        <tr>
                            <td class="text-muted" style="font-size: .82rem;">{{ msg.created_at|kyiv_time('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <span class="badge msg-role-badge {{ msg.role if msg.role in ['user','assistant','system'] else '' }}">{{ msg.role }}</span>
                            </td>
                            <td class="truncate-1" style="max-width: 320px;" title="{{ msg.content_clean }}">{{ msg.content_clean }}</td>
                            <td><a href="/messages/{{ msg.message_id }}" class="btn" style="padding:6px 10px; font-size:.82rem;">–î–µ—Ç–∞–ª—ñ</a></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4">
                                <div class="empty-state">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
</div>
{% endblock %}

