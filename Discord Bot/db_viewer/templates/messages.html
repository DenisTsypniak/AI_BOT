{% extends "base.html" %}

{% block title %}–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è - Live Role Bot{% endblock %}

{% block content %}
<style>
    .messages-filters {
        display: grid;
        grid-template-columns: minmax(220px, 1.5fr) repeat(4, minmax(120px, .65fr)) auto;
        gap: 10px;
        align-items: end;
    }
    .field {
        display: grid;
        gap: 6px;
        min-width: 0;
    }
    .field label {
        font-size: .78rem;
        color: var(--text-muted);
    }
    .field input, .field select {
        width: 100%;
        min-width: 0;
    }
    .messages-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: flex-end;
        align-items: center;
    }
    .messages-actions .btn {
        white-space: nowrap;
    }
    .messages-meta {
        display: grid;
        grid-template-columns: auto auto auto;
        gap: 8px;
        align-items: center;
    }
    .role-badge-system { background-color: rgba(245, 158, 11, .18) !important; border-color: rgba(245, 158, 11, .28) !important; color: #ffd88a !important; }
    .role-badge-assistant { background-color: rgba(16, 185, 129, .14) !important; border-color: rgba(16, 185, 129, .24) !important; color: #8ff0cc !important; }
    .role-badge-user { background-color: rgba(79, 141, 255, .14) !important; border-color: rgba(79, 141, 255, .24) !important; color: #b7d2ff !important; }
    .modality-pill {
        border-radius: 999px;
        border: 1px solid rgba(148,163,184,.14);
        background: rgba(255,255,255,.02);
        padding: 3px 8px;
        font-size: .74rem;
        white-space: nowrap;
    }
    .msg-transcript {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px dashed rgba(148,163,184,.18);
    }
    .msg-transcript-title {
        font-size: .75rem;
        text-transform: uppercase;
        color: #ffd88a;
        margin-bottom: 4px;
        letter-spacing: .06em;
    }
    .msg-transcript-body {
        color: var(--text-muted);
        font-style: italic;
    }
    @media (max-width: 1320px) {
        .messages-filters {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .messages-actions {
            justify-content: flex-start;
            grid-column: 1 / -1;
        }
    }
    @media (max-width: 760px) {
        .messages-filters {
            grid-template-columns: 1fr;
        }
    }
</style>

{% set filter_params = "" %}
{% for k, v in filters.items() %}
{% if v %}
{% set filter_params = filter_params ~ "&" ~ k ~ "=" ~ v|urlencode %}
{% endif %}
{% endfor %}

<div class="stack">
    <section class="page-header">
        <div class="split">
            <div>
                <h1 class="page-title">üí¨ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h1>
                <p class="page-description">–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –∂—É—Ä–Ω–∞–ª –≤–∑–∞—î–º–æ–¥—ñ–π –±–æ—Ç–∞ —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: —Ç–µ–∫—Å—Ç, –≥–æ–ª–æ—Å, —Ä–æ–ª—ñ, STT-—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∏ –π —à–≤–∏–¥–∫–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ –¥–µ—Ç–∞–ª–µ–π.</p>
            </div>
            <div class="chip-row">
                <span class="pill">–†—è–¥–∫–∏ <strong>{{ offset + 1 if messages else 0 }} ‚Äì {{ offset + messages|length }}</strong></span>
                <span class="pill">–õ—ñ–º—ñ—Ç <strong>{{ limit }}</strong></span>
                {% if filters.get('q') %}<span class="pill">–ü–æ—à—É–∫ <strong>{{ filters.get('q') }}</strong></span>{% endif %}
            </div>
        </div>
    </section>

    <section class="card">
        <form method="GET" action="/messages" class="messages-filters">
            <div class="field">
                <label for="q">–ü–æ—à—É–∫ —Ç–µ–∫—Å—Ç—É (`q`)</label>
                <input type="text" id="q" name="q" value="{{ filters.get('q', '') or '' }}" placeholder="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
            </div>
            <div class="field">
                <label for="guild_id">Guild ID</label>
                <input type="text" id="guild_id" name="guild_id" value="{{ filters.get('guild_id', '') or '' }}">
            </div>
            <div class="field">
                <label for="user_id">User ID</label>
                <input type="text" id="user_id" name="user_id" value="{{ filters.get('user_id', '') or '' }}">
            </div>
            <div class="field">
                <label for="role">–†–æ–ª—å</label>
                <select id="role" name="role">
                    <option value="">–í—Å—ñ</option>
                    <option value="user" {% if filters.get('role')=='user' %}selected{% endif %}>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</option>
                    <option value="assistant" {% if filters.get('role')=='assistant' %}selected{% endif %}>–ë–æ—Ç</option>
                    <option value="system" {% if filters.get('role')=='system' %}selected{% endif %}>–°–∏—Å—Ç–µ–º–∞</option>
                </select>
            </div>
            <div class="field">
                <label for="modality">–ú–æ–¥–∞–ª—å–Ω—ñ—Å—Ç—å</label>
                <select id="modality" name="modality">
                    <option value="">–í—Å—ñ</option>
                    <option value="text" {% if filters.get('modality')=='text' %}selected{% endif %}>–¢–µ–∫—Å—Ç</option>
                    <option value="voice" {% if filters.get('modality')=='voice' %}selected{% endif %}>–ì–æ–ª–æ—Å</option>
                </select>
            </div>
            <div class="messages-actions">
                <button type="submit" class="btn primary">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
                <a href="/messages" class="btn">–°–∫–∏–Ω—É—Ç–∏</a>
                <a href="/messages/csv?{{ filter_params }}" class="btn">Export CSV</a>
                <button type="button" class="btn" onclick="navigator.clipboard.writeText(window.location.href); this.innerText='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ';">üìã URL</button>
            </div>
        </form>
    </section>

    <div class="table-container">
        <h2>–†—è–¥–∫–∏ {{ offset + 1 if messages else 0 }} ‚Äì {{ offset + messages|length }}</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ß–∞—Å</th>
                    <th>–ê–≤—Ç–æ—Ä ID</th>
                    <th>–†–æ–ª—å</th>
                    <th>–ú–æ–¥–∞–ª—å–Ω—ñ—Å—Ç—å</th>
                    <th>–¢–µ–∫—Å—Ç</th>
                    <th>–î—ñ—ó</th>
                </tr>
            </thead>
            <tbody>
                {% for msg in messages %}
                <tr>
                    <td class="mono">{{ msg.message_id }}</td>
                    <td class="text-muted" style="font-size:.84rem;" title="{{ msg.created_at }}">{{ msg.created_at|kyiv_time }}</td>
                    <td class="mono">{{ msg.user_id }}</td>
                    <td>
                        {% set role_class = 'role-badge-system' if msg.role == 'system' else ('role-badge-assistant' if msg.role == 'assistant' else 'role-badge-user') %}
                        <span class="badge {{ role_class }}">{{ msg.role }}</span>
                    </td>
                    <td>
                        <span class="modality-pill">{{ 'üé§ –ì–æ–ª–æ—Å' if 'voice' in msg.modality else 'üìù –¢–µ–∫—Å—Ç' }}</span>
                    </td>
                    <td class="text-wrap" style="min-width: 280px; max-width: 680px;">
                        <div class="msg-content {% if msg.role == 'assistant' %}msg-assistant{% else %}msg-other{% endif %}">
                            {{ msg.content_clean }}
                        </div>
                        {% if msg.transcript %}
                        <div class="msg-transcript">
                            <div class="msg-transcript-title">üéôÔ∏è STT –†–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ (–≤–ø–µ–≤–Ω.: {{"%.2f"|format(msg.confidence)}})</div>
                            <div class="msg-transcript-body">"{{ msg.transcript }}"</div>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/messages/{{ msg.message_id }}" class="btn primary" style="padding: 6px 10px; font-size:.82rem;">–î–µ—Ç–∞–ª—ñ</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º.</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        {% set prev_offset = offset - limit %}
        {% set next_offset = offset + limit %}

        {% if offset > 0 %}
        <a href="/messages?limit={{ limit }}&offset={{ prev_offset }}{{ filter_params }}" class="btn">‚Üê –ù–æ–≤—ñ—à—ñ</a>
        {% else %}
        <button class="btn" disabled>‚Üê –ù–æ–≤—ñ—à—ñ</button>
        {% endif %}

        {% if messages|length == limit %}
        <a href="/messages?limit={{ limit }}&offset={{ next_offset }}{{ filter_params }}" class="btn">–°—Ç–∞—Ä—ñ—à—ñ ‚Üí</a>
        {% else %}
        <button class="btn" disabled>–°—Ç–∞—Ä—ñ—à—ñ ‚Üí</button>
        {% endif %}
    </div>
</div>
{% endblock %}

