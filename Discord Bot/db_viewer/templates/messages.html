{% extends "base.html" %}

{% block title %}–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è - Live Role Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –°–µ—Å—ñ–π</h1>
    <p class="page-description">–•—Ä–æ–Ω–æ–ª–æ–≥—ñ—á–Ω–∏–π –∂—É—Ä–Ω–∞–ª –≤–∑–∞—î–º–æ–¥—ñ—ó –±–æ—Ç–∞ —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.</p>
</div>
<style>
    .role-badge-system {
        background-color: var(--warning);
        color: #fff;
    }

    .role-badge-assistant {
        background-color: var(--success);
        color: #1a1a1a;
        font-weight: 500;
    }

    .role-badge-user {
        background-color: var(--accent);
        color: #fff;
    }
</style>

<div class="card" style="margin-bottom: 20px; padding: 15px;">
    <form method="GET" action="/messages" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-end;">
        <div style="flex: 1; min-width: 150px; padding-right: 5px;">
            <label for="q"
                style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">–ü–æ—à—É–∫ —Ç–µ–∫—Å—Ç—É
                (q)</label>
            <input type="text" id="q" name="q" value="{{ filters.get('q', '') or '' }}"
                placeholder="–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
                style="box-sizing: border-box; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-main);">
        </div>
        <div style="width: 140px; padding-right: 5px;">
            <label for="guild_id"
                style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">Guild
                ID</label>
            <input type="text" id="guild_id" name="guild_id" value="{{ filters.get('guild_id', '') or '' }}"
                style="box-sizing: border-box; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-main);">
        </div>
        <div style="width: 140px; padding-right: 5px;">
            <label for="user_id"
                style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">User ID</label>
            <input type="text" id="user_id" name="user_id" value="{{ filters.get('user_id', '') or '' }}"
                style="box-sizing: border-box; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-main);">
        </div>
        <div style="width: 100px; padding-right: 5px;">
            <label for="role"
                style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">–†–æ–ª—å</label>
            <select id="role" name="role"
                style="box-sizing: border-box; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-main);">
                <option value="">–í—Å—ñ</option>
                <option value="user" {% if filters.get('role')=='user' %}selected{% endif %}>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</option>
                <option value="assistant" {% if filters.get('role')=='assistant' %}selected{% endif %}>–ë–æ—Ç</option>
                <option value="system" {% if filters.get('role')=='system' %}selected{% endif %}>–°–∏—Å—Ç–µ–º–∞</option>
            </select>
        </div>
        <div style="width: 110px; padding-right: 5px;">
            <label for="modality"
                style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px;">–ú–æ–¥–∞–ª—å–Ω—ñ—Å—Ç—å</label>
            <select id="modality" name="modality"
                style="box-sizing: border-box; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-main);">
                <option value="">–í—Å—ñ</option>
                <option value="text" {% if filters.get('modality')=='text' %}selected{% endif %}>–¢–µ–∫—Å—Ç</option>
                <option value="voice" {% if filters.get('modality')=='voice' %}selected{% endif %}>–ì–æ–ª–æ—Å</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="submit" class="btn primary" style="padding: 8px 16px;">–§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏</button>
            <a href="/messages" class="btn" style="padding: 8px 16px;">–°–∫–∏–Ω—É—Ç–∏</a>

            {% set filter_params = "" %}
            {% for k, v in filters.items() %}
            {% if v %}
            {% set filter_params = filter_params ~ "&" ~ k ~ "=" ~ v|urlencode %}
            {% endif %}
            {% endfor %}
            <a href="/messages/csv?{{ filter_params }}" class="btn primary" style="padding: 8px 16px;">Export CSV</a>
            <button type="button" class="btn primary"
                onclick="navigator.clipboard.writeText(window.location.href); this.innerText='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';"
                style="padding: 8px 16px;">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ URL –§—ñ–ª—å—Ç—Ä—É</button>
        </div>
    </form>
</div>

<div class="table-container">
    <h2 style="margin: 15px 15px 10px 15px; font-size: 1.2rem;">–†—è–¥–∫–∏ {{ offset + 1 }} - {{ offset + messages|length }}
    </h2>
    <table>
        <thead>
            <tr>
                <th style="width: 60px;">ID</th>
                <th style="width: 150px;">–ß–∞—Å</th>
                <th style="width: 150px;">–ê–≤—Ç–æ—Ä ID</th>
                <th style="width: 80px;">–†–æ–ª—å</th>
                <th style="width: 100px;">–ú–æ–¥–∞–ª—å–Ω—ñ—Å—Ç—å</th>
                <th>–¢–µ–∫—Å—Ç</th>
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody>
            {% for msg in messages %}
            <tr>
                <td>{{ msg.message_id }}</td>
                <td style="color: var(--text-muted); font-size: 0.85rem;" title="{{ msg.created_at }}">{{
                    msg.created_at|kyiv_time }}</td>
                <td style="font-family: monospace;">{{ msg.user_id }}</td>
                <td>
                    {% set role_class = 'role-badge-system' if msg.role == 'system' else ('role-badge-assistant' if
                    msg.role == 'assistant' else 'role-badge-user') %}
                    <span class="badge {{ role_class }}">{{ msg.role }}</span>
                </td>
                <td>
                    <span class="badge"
                        style="background-color: var(--surface-color); border: 1px solid var(--border-color);">
                        {{ 'üé§ –ì–æ–ª–æ—Å' if 'voice' in msg.modality else 'üìù –¢–µ–∫—Å—Ç' }}
                    </span>
                </td>
                <td class="text-wrap">
                    <div
                        class="msg-content {% if msg.role == 'assistant' %}msg-assistant{% else %}msg-other{% endif %}">
                        {{ msg.content_clean }}</div>

                    {% if msg.transcript %}
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border-color);">
                        <div
                            style="font-size: 0.75rem; text-transform: uppercase; color: var(--warning); margin-bottom: 4px;">
                            üéôÔ∏è STT –†–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞ (–í–ø–µ–≤–Ω.: {{"%.2f"|format(msg.confidence)}})</div>
                        <div style="font-style: italic; color: var(--text-muted);">"{{ msg.transcript }}"</div>
                    </div>
                    {% endif %}
                </td>
                <td>
                    <a href="/messages/{{ msg.message_id }}" class="btn primary"
                        style="padding: 4px 10px; font-size: 0.85rem;">–î–µ—Ç.</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 30px; color: var(--text-muted);">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–µ
                    –∑–Ω–∞–π–¥–µ–Ω–æ.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="pagination">
    {% set prev_offset = offset - limit %}
    {% set next_offset = offset + limit %}

    {% set filter_params = "" %}
    {% for k, v in filters.items() %}
    {% if v %}
    {% set filter_params = filter_params ~ "&" ~ k ~ "=" ~ v|urlencode %}
    {% endif %}
    {% endfor %}

    {% if offset > 0 %}
    <a href="/messages?limit={{ limit }}&offset={{ prev_offset }}{{ filter_params }}" class="btn">–ù–æ–≤—ñ—à—ñ</a>
    {% else %}
    <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">–ù–æ–≤—ñ—à—ñ</button>
    {% endif %}

    {% if messages|length == limit %}
    <a href="/messages?limit={{ limit }}&offset={{ next_offset }}{{ filter_params }}" class="btn">–°—Ç–∞—Ä—ñ—à—ñ</a>
    {% else %}
    <button class="btn" disabled style="opacity: 0.5; cursor: not-allowed;">–°—Ç–∞—Ä—ñ—à—ñ</button>
    {% endif %}
</div>
{% endblock %}
