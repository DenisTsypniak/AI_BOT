{% extends "base.html" %}

{% block title %}Особистість Лізи - Live Role Bot{% endblock %}

{% macro state_badge(status) -%}
    {% set s = (status or 'unknown') %}
    {% if s == 'confirmed' %}
        <span class="lz-pill ok">підтверджено</span>
    {% elif s == 'candidate' %}
        <span class="lz-pill warn">кандидат</span>
    {% elif s == 'active' %}
        <span class="lz-pill ok">активна</span>
    {% elif s == 'emerging' %}
        <span class="lz-pill warn">формується</span>
    {% else %}
        <span class="lz-pill">{{ s }}</span>
    {% endif %}
{%- endmacro %}

{% block content %}
<style>
    .lz-page { display:grid; gap:18px; }
    .lz-hero {
        background:
            radial-gradient(700px 220px at 10% -10%, rgba(59,130,246,.24), transparent 60%),
            radial-gradient(600px 240px at 90% 0%, rgba(16,185,129,.12), transparent 65%),
            linear-gradient(180deg, rgba(30,41,59,.96), rgba(17,24,39,.96));
        border: 1px solid rgba(148,163,184,.14);
        border-radius: 18px;
        padding: 18px;
        position: relative;
        overflow: hidden;
    }
    .lz-hero:before {
        content: "";
        position: absolute;
        inset: 0;
        background-image:
            linear-gradient(rgba(255,255,255,.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,.02) 1px, transparent 1px);
        background-size: 24px 24px;
        opacity: .35;
        pointer-events: none;
    }
    .lz-hero-inner { position: relative; z-index: 1; display:grid; gap:14px; }
    .lz-hero-top { display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:start; }
    .lz-title h1 { margin:0; font-size:2rem; line-height:1.08; letter-spacing:-.02em; }
    .lz-title p { margin:8px 0 0; color: var(--text-muted); line-height:1.45; max-width: 70ch; }
    .lz-actions { display:flex; flex-wrap:wrap; gap:10px; }
    .lz-actions .btn { border-radius: 12px; }
    .lz-sidebox {
        background: rgba(15,23,42,.45);
        border: 1px solid rgba(148,163,184,.16);
        border-radius: 14px;
        padding: 12px;
        display:grid;
        gap:10px;
    }
    .lz-sidebox h3 { margin:0; font-size:.9rem; }
    .lz-mini { display:grid; gap:8px; font-size:.86rem; }
    .lz-mini .row { display:flex; justify-content:space-between; gap:8px; }
    .lz-mini .k { color: var(--text-muted); }
    .lz-stats { display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:12px; }
    .lz-stat {
        border-radius: 14px;
        border: 1px solid rgba(148,163,184,.13);
        background: rgba(255,255,255,.015);
        padding: 12px;
    }
    .lz-stat .k { color: var(--text-muted); font-size:.74rem; text-transform: uppercase; letter-spacing:.08em; font-weight:700; }
    .lz-stat .v { margin-top:8px; font-size:1.55rem; font-weight:700; line-height:1; color: var(--accent); }
    .lz-stat .s { margin-top:7px; color: var(--text-muted); font-size:.8rem; line-height:1.3; }

    .lz-layout { display:grid; grid-template-columns: 1.35fr .65fr; gap:18px; align-items:start; }
    .lz-main, .lz-side { display:grid; gap:18px; }
    .lz-side { position: sticky; top: 20px; }

    .lz-card {
        background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--surface-color);
        border: 1px solid rgba(148,163,184,.14);
        border-radius: 16px;
        padding: 14px;
    }
    .lz-head { display:flex; justify-content:space-between; align-items:flex-start; gap:10px; margin-bottom:10px; flex-wrap: wrap; }
    .lz-head h2, .lz-head h3 { margin:0; line-height:1.2; }
    .lz-head h2 { font-size:1.02rem; }
    .lz-head h3 { font-size:.94rem; }
    .lz-sub { color: var(--text-muted); font-size:.82rem; margin-top:4px; }
    .lz-empty {
        border: 1px dashed rgba(148,163,184,.18);
        border-radius: 12px;
        padding: 14px;
        color: var(--text-muted);
        text-align: center;
        line-height: 1.4;
        background: rgba(15,23,42,.15);
    }
    .lz-chips { display:flex; flex-wrap:wrap; gap:8px; }
    .lz-chip {
        display:inline-flex; align-items:center; gap:8px;
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background: rgba(255,255,255,.015); font-size:.8rem;
    }
    .lz-chip b { color: var(--text-main); }
    .lz-pill {
        display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px;
        border:1px solid rgba(148,163,184,.18); color: var(--text-muted);
        background: rgba(255,255,255,.015); font-size:.72rem; font-weight:700;
        text-transform: uppercase; letter-spacing:.05em; line-height:1;
    }
    .lz-pill.ok { color:#86efac; border-color: rgba(16,185,129,.25); background: rgba(16,185,129,.08); }
    .lz-pill.warn { color:#fcd34d; border-color: rgba(245,158,11,.22); background: rgba(245,158,11,.08); }
    .lz-bio { line-height:1.55; font-size:.95rem; }

    .lz-grid { display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    .lz-traits { display:grid; gap:10px; }
    .lz-trait {
        border:1px solid rgba(148,163,184,.12); border-radius: 12px;
        padding: 11px; background: rgba(255,255,255,.015);
    }
    .lz-trait-top { display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .lz-trait-name { margin:0; font-size:.92rem; }
    .lz-key { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: var(--accent); font-size:.75rem; margin-top:4px; word-break: break-word; }
    .lz-trait-desc { margin-top:8px; color: var(--text-muted); font-size:.83rem; line-height:1.35; }
    .lz-metrics { margin-top:9px; display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:8px; }
    .lz-m { border:1px solid rgba(148,163,184,.1); border-radius:10px; padding:6px 7px; background: rgba(15,23,42,.17); }
    .lz-m .k { color: var(--text-muted); font-size:.68rem; text-transform: uppercase; letter-spacing:.05em; display:block; }
    .lz-m .v { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.78rem; display:block; margin-top:3px; }

    .lz-facts { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:10px; }
    .lz-fact {
        border:1px solid rgba(148,163,184,.12); border-radius: 12px; padding: 11px;
        background: rgba(255,255,255,.015); display:grid; gap:7px; align-content:start;
    }
    .lz-fact-value { font-size:.94rem; line-height:1.35; word-break: break-word; }
    .lz-fact-meta { display:flex; gap:6px; flex-wrap:wrap; }
    .lz-quote { color: var(--text-muted); font-size:.78rem; line-height:1.35; border-left:2px solid rgba(148,163,184,.14); padding-left:7px; }
    .lz-fact-foot { display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; color: var(--text-muted); font-size:.78rem; }

    .lz-timeline { display:grid; gap:10px; }
    .lz-event {
        display:grid; grid-template-columns: auto 1fr; gap:10px; align-items:start;
        border:1px solid rgba(148,163,184,.12); border-radius:12px; padding:10px; background: rgba(255,255,255,.015);
    }
    .lz-dot { width:10px; height:10px; border-radius:50%; margin-top:4px; background: var(--accent); box-shadow: 0 0 0 4px rgba(59,130,246,.12); }
    .lz-event h4 { margin:0; font-size:.9rem; line-height:1.25; }
    .lz-event-meta { margin-top:4px; color: var(--text-muted); font-size:.78rem; }
    .lz-event-desc { margin-top:6px; color: var(--text-muted); font-size:.83rem; line-height:1.35; }

    details.lz-details { border:1px solid rgba(148,163,184,.12); border-radius: 14px; background: rgba(255,255,255,.015); }
    details.lz-details > summary {
        cursor:pointer; list-style:none; padding:12px 14px;
        display:flex; justify-content:space-between; align-items:center; gap:10px; font-weight:600;
    }
    details.lz-details > summary::-webkit-details-marker { display:none; }
    .lz-details-body { border-top:1px solid rgba(148,163,184,.12); padding:12px 14px 14px; display:grid; gap:12px; }
    .lz-log { display:grid; gap:8px; }
    .lz-log-item { border:1px solid rgba(148,163,184,.1); border-radius: 10px; padding: 10px; background: rgba(255,255,255,.01); }
    .lz-log-top { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-bottom:5px; }
    .lz-log-tags { display:flex; gap:6px; flex-wrap:wrap; }
    .lz-line { color: var(--text-muted); font-size:.8rem; line-height:1.35; }

    @media (max-width: 1180px) { .lz-layout { grid-template-columns: 1fr; } .lz-side { position: static; } }
    @media (max-width: 980px) { .lz-hero-top, .lz-grid { grid-template-columns: 1fr; } .lz-stats { grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (max-width: 620px) { .lz-stats { grid-template-columns: 1fr; } .lz-metrics { grid-template-columns: repeat(2,minmax(0,1fr)); } .lz-title h1 { font-size:1.55rem; } }
</style>

{% set bio = persona_biography %}
{% set has_bio = bio and (bio.summary_text or '')|trim %}

<div class="lz-page">
    <section class="lz-hero">
        <div class="lz-hero-inner">
            <div class="lz-hero-top">
                <div class="lz-title">
                    <h1>🎭 Особистість Лізи</h1>
                    <p>Живий портрет персонажа: пам'ять про себе, характер, розвиток і події, які його формують.</p>
                    <div class="lz-actions" style="margin-top:12px;">
                        <a href="/persona/memory" class="btn primary">Пам'ять персони</a>
                        <a href="/persona" class="btn">Стан персони</a>
                        <a href="/persona/reflections" class="btn">Рефлексії</a>
                        <a href="/persona/relationships" class="btn">Відносини</a>
                    </div>
                </div>
                <div class="lz-sidebox">
                    <h3>Швидкий стан</h3>
                    <div class="lz-mini">
                        <div class="row"><span class="k">Self-facts</span><strong>{{ summary.total_facts or 0 }}</strong></div>
                        <div class="row"><span class="k">Підтверджені</span><strong>{{ summary.confirmed_facts or 0 }}</strong></div>
                        <div class="row"><span class="k">Кандидати</span><strong>{{ summary.candidate_facts or 0 }}</strong></div>
                        <div class="row"><span class="k">Оновлено</span><strong>{{ summary.last_fact_update|kyiv_time(default='н/д') }}</strong></div>
                    </div>
                </div>
            </div>

            <div class="lz-stats">
                <div class="lz-stat">
                    <div class="k">Біографія</div>
                    <div class="v">{% if has_bio %}1{% else %}0{% endif %}</div>
                    <div class="s">{% if has_bio %}persona summary активний{% else %}ще не згенерована{% endif %}</div>
                </div>
                <div class="lz-stat">
                    <div class="k">Риси</div>
                    <div class="v">{{ summary.traits_total or 0 }}</div>
                    <div class="s">active: {{ summary.traits_active or 0 }}, emerging: {{ summary.traits_emerging or 0 }}</div>
                </div>
                <div class="lz-stat">
                    <div class="k">Сер. впевненість</div>
                    <div class="v">{{ '%.2f'|format(summary.avg_confidence or 0) }}</div>
                    <div class="s">по self-facts у довгій пам'яті</div>
                </div>
                <div class="lz-stat">
                    <div class="k">Показано фактів</div>
                    <div class="v">{{ highlight_facts|length }}</div>
                    <div class="s">ключові self-facts у цій картці</div>
                </div>
            </div>
        </div>
    </section>

    <div class="lz-layout">
        <main class="lz-main">
            <section class="lz-card">
                <div class="lz-head">
                    <div>
                        <h2>📖 Поточна біографія Лізи</h2>
                        <div class="lz-sub">Стислий опис персонажа на основі накопичених self-facts</div>
                    </div>
                    {% if has_bio %}<span class="lz-pill ok">persona summary</span>{% endif %}
                </div>
                {% if has_bio %}
                    <div class="lz-bio text-wrap">{{ bio.summary_text }}</div>
                    <div class="lz-chips" style="margin-top:12px;">
                        <span class="lz-chip"><span>Джерело фактів</span><b>{{ bio.source_fact_count or 0 }}</b></span>
                        <span class="lz-chip"><span>Оновлено</span><b>{{ bio.updated_at|kyiv_time(default='н/д') }}</b></span>
                        {% if bio.last_source_guild_id %}<span class="lz-chip"><span>Guild</span><b>{{ bio.last_source_guild_id }}</b></span>{% endif %}
                    </div>
                {% else %}
                    <div class="lz-empty">Біографія ще не сформована. Потрібно більше self-facts і фоновий цикл оновлення пам'яті.</div>
                {% endif %}
            </section>

            <div class="lz-grid">
                <section class="lz-card">
                    <div class="lz-head">
                        <div>
                            <h2>🧬 Ядро характеру</h2>
                            <div class="lz-sub">Домінуючі риси, які визначають поведінку зараз</div>
                        </div>
                        <span class="lz-chip"><span>Active</span><b>{{ summary.traits_active or 0 }}</b></span>
                    </div>
                    {% if dominant_traits %}
                        <div class="lz-traits">
                            {% for trait in dominant_traits %}
                                <article class="lz-trait">
                                    <div class="lz-trait-top">
                                        <div>
                                            <h3 class="lz-trait-name">{{ trait.label }}</h3>
                                            <div class="lz-key">{{ trait.trait_key }}</div>
                                        </div>
                                        {{ state_badge(trait.status) }}
                                    </div>
                                    <div class="lz-trait-desc text-wrap">{{ trait.description }}</div>
                                    <div class="lz-metrics">
                                        <div class="lz-m"><span class="k">Current</span><span class="v">{{ '%+.2f'|format(trait.current_value or 0) }}</span></div>
                                        <div class="lz-m"><span class="k">Anchor</span><span class="v">{{ '%+.2f'|format(trait.anchor_value or 0) }}</span></div>
                                        <div class="lz-m"><span class="k">Drift</span><span class="v">{{ '%+.3f'|format(trait.drift_velocity or 0) }}</span></div>
                                        <div class="lz-m"><span class="k">Evidence</span><span class="v">{{ trait.evidence_count or 0 }}</span></div>
                                    </div>
                                </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="lz-empty">Риси персони ще не зчитано.</div>
                    {% endif %}
                </section>

                <section class="lz-card">
                    <div class="lz-head">
                        <div>
                            <h2>🌱 Риси, що формуються</h2>
                            <div class="lz-sub">Те, що набирає силу, але ще не стало стабільним</div>
                        </div>
                        <span class="lz-chip"><span>Emerging</span><b>{{ summary.traits_emerging or 0 }}</b></span>
                    </div>
                    {% if emerging_traits %}
                        <div class="lz-traits">
                            {% for trait in emerging_traits %}
                                <article class="lz-trait" style="border-left: 3px solid rgba(245,158,11,.9); background: rgba(245,158,11,.035);">
                                    <div class="lz-trait-top">
                                        <div>
                                            <h3 class="lz-trait-name">{{ trait.label }}</h3>
                                            <div class="lz-key">{{ trait.trait_key }}</div>
                                        </div>
                                        {{ state_badge(trait.status) }}
                                    </div>
                                    <div class="lz-trait-desc text-wrap">{{ trait.description }}</div>
                                    <div class="lz-chips" style="margin-top:9px;">
                                        <span class="lz-chip"><span>Current</span><b>{{ '%+.2f'|format(trait.current_value or 0) }}</b></span>
                                        <span class="lz-chip"><span>Drift</span><b>{{ '%+.3f'|format(trait.drift_velocity or 0) }}</b></span>
                                        <span class="lz-chip"><span>Evidence</span><b>{{ trait.evidence_count or 0 }}</b></span>
                                    </div>
                                </article>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="lz-empty">Наразі немає виражених рис, що формуються.</div>
                    {% endif %}
                </section>
            </div>

            <section class="lz-card">
                <div class="lz-head">
                    <div>
                        <h2>🍽️ Що Ліза пам'ятає про себе</h2>
                        <div class="lz-sub">Ключові self-facts, які підтримують безперервність особистості</div>
                    </div>
                    <div class="lz-chips">
                        <span class="lz-chip"><span>Підтверджені</span><b>{{ summary.confirmed_facts or 0 }}</b></span>
                        <span class="lz-chip"><span>Pinned</span><b>{{ summary.pinned_facts or 0 }}</b></span>
                    </div>
                </div>
                {% if highlight_facts %}
                    <div class="lz-facts">
                        {% for fact in highlight_facts %}
                            <article class="lz-fact">
                                <div class="lz-key">{{ fact.fact_key }}</div>
                                <div class="lz-fact-value">{{ fact.fact_value }}{% if fact.pinned %} <span title="Закріплений факт">📌</span>{% endif %}</div>
                                <div class="lz-fact-meta">
                                    {{ state_badge(fact.status) }}
                                    <span class="lz-pill">{{ fact.about_target or 'assistant_self' }}</span>
                                    <span class="lz-pill">{{ fact.directness or 'explicit' }}</span>
                                </div>
                                {% if fact.evidence_quote %}<div class="lz-quote text-wrap">«{{ fact.evidence_quote }}»</div>{% endif %}
                                <div class="lz-fact-foot">
                                    <span>confidence {{ '%.2f'|format(fact.confidence or 0) }}</span>
                                    <span>{{ fact.updated_at|kyiv_time(default='н/д') }}</span>
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="lz-empty">Self-facts ще порожні. Поспілкуйся з ботом, щоб Ліза сказала щось про себе.</div>
                {% endif %}
            </section>
        </main>

        <aside class="lz-side">
            <section class="lz-card">
                <div class="lz-head">
                    <div>
                        <h3>🎞️ Події, що формують Лізу</h3>
                        <div class="lz-sub">Останні епізоди пам'яті персонажа</div>
                    </div>
                    <span class="lz-chip"><span>Епізоди</span><b>{{ episodes|length }}</b></span>
                </div>
                {% if episodes %}
                    <div class="lz-timeline">
                        {% for ep in episodes %}
                            <article class="lz-event">
                                <div class="lz-dot"></div>
                                <div>
                                    <div style="display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; align-items:flex-start;">
                                        <h4>{{ ep.title }}</h4>
                                        {{ state_badge(ep.status) }}
                                    </div>
                                    <div class="lz-event-meta">{{ ep.episode_type }} • важливість {{ '%.2f'|format(ep.importance or 0) }} • {{ ep.updated_at|kyiv_time(default='н/д') }}</div>
                                    {% if ep.summary %}<div class="lz-event-desc text-wrap">{{ ep.summary }}</div>{% endif %}
                                </div>
                            </article>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="lz-empty">Епізодична пам'ять персони ще порожня.</div>
                {% endif %}
            </section>

            <details class="lz-details">
                <summary>
                    <span>🧪 Технічний журнал формування пам'яті</span>
                    <span class="lz-sub">Extractor / moderation / save</span>
                </summary>
                <div class="lz-details-body">
                    <section>
                        <div class="lz-head" style="margin-bottom:8px;">
                            <div>
                                <h3>Останні Extractor runs</h3>
                                <div class="lz-sub">Backend, JSON, режим застосування</div>
                            </div>
                            <span class="lz-chip"><span>Runs</span><b>{{ recent_runs|length }}</b></span>
                        </div>
                        {% if recent_runs %}
                            <div class="lz-log">
                                {% for run in recent_runs %}
                                    <article class="lz-log-item">
                                        <div class="lz-log-top">
                                            <div class="lz-log-tags">
                                                <span class="lz-pill">{{ run.backend_name or 'backend' }}</span>
                                                {% if run.model_name %}<span class="lz-pill">{{ run.model_name }}</span>{% endif %}
                                                {% if run.dry_run %}<span class="lz-pill warn">dry-run</span>{% else %}<span class="lz-pill ok">apply</span>{% endif %}
                                            </div>
                                            <div class="lz-sub">{{ run.created_at|kyiv_time(default='н/д') }}</div>
                                        </div>
                                        <div class="lz-line">кандидати: {{ run.candidate_count or 0 }}, accepted: {{ run.accepted_count or 0 }}, збережено: {{ run.saved_count or 0 }}</div>
                                        <div class="lz-line">JSON: {% if run.json_valid %}ok{% elif run.llm_attempted %}bad{% else %}n/a{% endif %}{% if run.latency_ms %} • {{ run.latency_ms|int }} ms{% endif %}</div>
                                        {% if run.error_text %}<div class="lz-line text-wrap" style="color:#fca5a5; margin-top:3px;">{{ run.error_text }}</div>{% endif %}
                                    </article>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="lz-empty">Extractor runs для персони ще не було.</div>
                        {% endif %}
                    </section>

                    <section>
                        <div class="lz-head" style="margin-bottom:8px;">
                            <div>
                                <h3>Останні кандидати self-facts</h3>
                                <div class="lz-sub">Рішення модерації та запис у пам'ять</div>
                            </div>
                            <span class="lz-chip"><span>Candidates</span><b>{{ recent_candidates|length }}</b></span>
                        </div>
                        {% if recent_candidates %}
                            <div class="lz-log">
                                {% for row in recent_candidates %}
                                    {% set action = row.moderation_action or 'accept' %}
                                    <article class="lz-log-item">
                                        <div class="lz-log-top">
                                            <div class="lz-log-tags">
                                                <span class="lz-pill">{{ row.fact_key }}</span>
                                                <span class="lz-pill">{{ row.directness or 'explicit' }}</span>
                                                <span class="lz-pill {% if action == 'accept' %}ok{% else %}warn{% endif %}">{{ action }}</span>
                                            </div>
                                            <div class="lz-sub">{{ row.created_at|kyiv_time(default='н/д') }}</div>
                                        </div>
                                        <div class="lz-line text-wrap"><strong>{{ row.fact_value }}</strong></div>
                                        <div class="lz-line">{% if row.saved_to_memory %}збережено в пам'ять{% else %}не збережено{% endif %}{% if row.confidence is not none %} • confidence {{ '%.2f'|format(row.confidence or 0) }}{% endif %}</div>
                                        {% if row.evidence_quote %}<div class="lz-line text-wrap" style="margin-top:3px;">«{{ row.evidence_quote }}»</div>{% endif %}
                                    </article>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="lz-empty">Кандидатів self-facts поки немає.</div>
                        {% endif %}
                    </section>
                </div>
            </details>
        </aside>
    </div>
</div>
{% endblock %}
