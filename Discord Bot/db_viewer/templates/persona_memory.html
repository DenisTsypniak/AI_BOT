{% extends "base.html" %}

{% block title %}–ü–∞–º'—è—Ç—å –ü–µ—Ä—Å–æ–Ω–∏ - Live Role Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üß† –ü–∞–º'—è—Ç—å –ü–µ—Ä—Å–æ–Ω–∏</h1>
    <p class="page-description">
        –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è self-facts –±–æ—Ç–∞, –±—ñ–æ–≥—Ä–∞—Ñ—ñ—ó –ø–µ—Ä—Å–æ–Ω–∏, –¥–∂–µ—Ä–µ–ª –¥–æ–∫–∞–∑—ñ–≤ —Ç–∞ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö —Ä—ñ—à–µ–Ω—å –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞ –ø–∞–º'—è—Ç—ñ.
    </p>
    <div style="margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="/persona/card" class="btn primary">–ö–∞—Ä—Ç–∫–∞ –ü–µ—Ä—Å–æ–Ω–∏</a>
        <a href="/persona" class="btn">‚Üê –ù–∞–∑–∞–¥ –¥–æ –ü–µ—Ä—Å–æ–Ω–∏</a>
        <a href="/memory/provenance" class="btn">–ü–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ</a>
        <a href="/memory/extractor" class="btn">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –µ–∫—Å—Ç—Ä–∞–∫—Ç–æ—Ä–∞</a>
        <a href="/persona/memory?fact_limit={{ fact_limit }}&fact_offset={{ fact_offset }}&run_limit={{ run_limit }}&candidate_limit={{ candidate_limit }}" class="btn">–û–Ω–æ–≤–∏—Ç–∏</a>
    </div>
</div>

<div class="stats-grid" style="margin-bottom: 24px;">
    <div class="stat-card">
        <div class="stat-title">–§–∞–∫—Ç—ñ–≤ –ü–µ—Ä—Å–æ–Ω–∏</div>
        <div class="stat-value">{{ summary.total_facts or 0 }}</div>
        <div class="stat-subtitle">subjects: {{ summary.persona_subjects or 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω—ñ / –ö–∞–Ω–¥–∏–¥–∞—Ç–∏</div>
        <div class="stat-value">{{ summary.confirmed_facts or 0 }} / {{ summary.candidate_facts or 0 }}</div>
        <div class="stat-subtitle">pinned: {{ summary.pinned_facts or 0 }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">–°–µ—Ä. –í–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å</div>
        <div class="stat-value">{{ "%.2f"|format(summary.avg_confidence or 0) }}</div>
        <div class="stat-subtitle">last: {{ summary.last_fact_update|kyiv_time(default='–Ω/–¥') }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-title">Extractor (Persona)</div>
        <div class="stat-value">{{ recent_runs|length }}</div>
        <div class="stat-subtitle">–∫–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤: {{ recent_candidates|length }}, reject: {{ rejected_candidates|length }}</div>
    </div>
</div>

<h2 style="margin-top: 0;">üìò –ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è –ü–µ—Ä—Å–æ–Ω–∏</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Subject ID</th>
                <th>–ë—ñ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–µ –∑–≤–µ–¥–µ–Ω–Ω—è</th>
                <th>–§–∞–∫—Ç—ñ–≤</th>
                <th>–û—Å—Ç–∞–Ω–Ω—ñ–π Guild</th>
                <th>–û–Ω–æ–≤–ª–µ–Ω–æ</th>
            </tr>
        </thead>
        <tbody>
            {% for row in biographies %}
            <tr>
                <td style="font-family: monospace;">
                    <span class="badge blue">{{ row.subject_kind }}</span>
                    <div style="margin-top: 6px;">{{ row.subject_id }}</div>
                </td>
                <td class="text-wrap">{{ row.summary_text }}</td>
                <td>{{ row.source_fact_count or 0 }}</td>
                <td style="font-family: monospace;">{{ row.last_source_guild_id or '‚Äî' }}</td>
                <td style="font-size: 0.85rem; color: var(--text-muted);">{{ row.updated_at|kyiv_time(default='–Ω/–¥') }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 24px; color: var(--text-muted);">
                    –ë—ñ–æ–≥—Ä–∞—Ñ—ñ—è –ø–µ—Ä—Å–æ–Ω–∏ —â–µ –Ω–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∞.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2 style="margin-top: 32px;">üçΩÔ∏è Self-Facts –ü–µ—Ä—Å–æ–Ω–∏ (—â–æ –±–æ—Ç ‚Äú–ø–∞–º'—è—Ç–∞—î‚Äù –ø—Ä–æ —Å–µ–±–µ)</h2>
<div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
    <a href="/persona/memory?fact_limit={{ fact_limit }}&fact_offset={{ fact_offset + fact_limit }}&run_limit={{ run_limit }}&candidate_limit={{ candidate_limit }}" class="btn {% if not has_next_facts_page %}disabled{% endif %}">–ù–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ —Ñ–∞–∫—Ç—ñ–≤</a>
    {% if fact_offset > 0 %}
    <a href="/persona/memory?fact_limit={{ fact_limit }}&fact_offset={{ prev_fact_offset }}&run_limit={{ run_limit }}&candidate_limit={{ candidate_limit }}" class="btn">–ü–æ–ø–µ—Ä–µ–¥–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞</a>
    {% endif %}
    <span class="badge">limit={{ fact_limit }}</span>
    <span class="badge">offset={{ fact_offset }}</span>
</div>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Persona ID</th>
                <th>–§–∞–∫—Ç</th>
                <th>–ó–Ω–∞—á–µ–Ω–Ω—è</th>
                <th>Meta</th>
                <th>–°—Ç–∞–Ω</th>
                <th>Conf / Imp</th>
                <th>–î–∂–µ—Ä–µ–ª–∞ (guild)</th>
                <th>–û–Ω–æ–≤–ª–µ–Ω–æ</th>
            </tr>
        </thead>
        <tbody>
            {% for fact in facts %}
            <tr>
                <td style="font-family: monospace;">
                    {{ fact.persona_id or fact.user_id }}
                    <div style="font-size:0.75rem; color:var(--text-muted);">{{ fact.user_id }}</div>
                </td>
                <td><span class="badge blue">{{ fact.fact_key }}</span></td>
                <td class="text-wrap">
                    {{ fact.fact_value }}
                    {% if fact.pinned %}
                    <span title="–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–∏–π —Ñ–∞–∫—Ç" style="cursor: help;">üìå</span>
                    {% endif %}
                </td>
                <td>
                    <div class="badge blue" style="margin:2px 4px 2px 0;">{{ fact.about_target or 'assistant_self' }}</div>
                    <div class="badge" style="margin:2px 4px 2px 0;">{{ fact.directness or 'explicit' }}</div>
                    {% if fact.evidence_quote %}
                    <div class="text-wrap" style="margin-top:4px; max-width:260px; font-size:0.78rem; color:var(--text-muted);">
                        "{{ fact.evidence_quote }}"
                    </div>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if fact.status == 'confirmed' %}green{% elif fact.status == 'candidate' %}yellow{% else %}blue{% endif %}">
                        {{ fact.status or 'unknown' }}
                    </span>
                </td>
                <td>
                    <div>{{ "%.2f"|format(fact.confidence or 0) }}</div>
                    <div style="font-size:0.78rem; color:var(--text-muted);">imp={{ "%.2f"|format(fact.importance or 0) }}</div>
                </td>
                <td>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:4px;">
                        evidence={{ fact.provenance_evidence_count or fact.evidence_count or 0 }}
                    </div>
                    {% for item in fact.provenance_guild_breakdown or [] %}
                    <div class="badge" style="margin: 2px 4px 2px 0;">{{ item.guild_id or '(none)' }}: {{ item.count }}</div>
                    {% else %}
                    <span class="text-muted" style="font-size:0.8rem;">–Ω–µ–º–∞ evidence rows</span>
                    {% endfor %}
                    {% if fact.provenance_directness_breakdown %}
                    <div style="margin-top:6px;">
                        {% for item in fact.provenance_directness_breakdown or [] %}
                        <span class="badge blue" style="margin: 2px 4px 2px 0;">{{ item.directness or 'explicit' }}: {{ item.count }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </td>
                <td style="font-size:0.85rem; color:var(--text-muted);">{{ fact.updated_at|kyiv_time(default='–Ω/–¥') }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="8" style="text-align:center; padding:24px; color:var(--text-muted);">
                    Self-facts –ø–µ—Ä—Å–æ–Ω–∏ —â–µ –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ. –ü–æ—Å–ø—ñ–ª–∫—É–π—Å—è –∑ –±–æ—Ç–æ–º —ñ –∑–∞–ø–∏—Ç–∞–π —â–æ—Å—å –ø—Ä–æ –Ω–µ—ó, —â–æ–± –≤–æ–Ω–∞ —Å–∫–∞–∑–∞–ª–∞ —Ñ–∞–∫—Ç –ø—Ä–æ —Å–µ–±–µ.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2 style="margin-top: 32px;">üß™ –û—Å—Ç–∞–Ω–Ω—ñ –∑–∞–ø—É—Å–∫–∏ extractor-–∞ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∏</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>Guild / Channel</th>
                <th>Backend</th>
                <th>Mode</th>
                <th>–ö–∞–Ω–¥–∏–¥–∞—Ç–∏</th>
                <th>–ü—Ä–∏–π–Ω—è—Ç–æ</th>
                <th>–ó–±–µ—Ä–µ–∂–µ–Ω–æ</th>
                <th>JSON</th>
                <th>–ü–æ–º–∏–ª–∫–∞</th>
            </tr>
        </thead>
        <tbody>
            {% for row in recent_runs %}
            <tr>
                <td style="font-size:0.85rem; color:var(--text-muted);">{{ row.created_at|kyiv_time(default='–Ω/–¥') }}</td>
                <td>
                    <div style="font-family: monospace; font-size:0.8rem;">g={{ row.guild_id or '' }}</div>
                    <div style="font-family: monospace; font-size:0.8rem; color:var(--text-muted);">c={{ row.channel_id or '' }}</div>
                </td>
                <td>
                    <span class="badge">{{ row.backend_name or '' }}</span>
                    <div style="font-size:0.78rem; color:var(--text-muted); font-family: monospace;">{{ row.model_name or '' }}</div>
                </td>
                <td>
                    {% if row.dry_run %}
                    <span class="badge yellow">dry-run</span>
                    {% else %}
                    <span class="badge green">apply</span>
                    {% endif %}
                </td>
                <td>{{ row.candidate_count or 0 }}</td>
                <td>{{ row.accepted_count or 0 }}</td>
                <td>{{ row.saved_count or 0 }}</td>
                <td>
                    {% if row.llm_attempted and row.json_valid %}
                    <span class="badge green">json=ok</span>
                    {% elif row.llm_attempted %}
                    <span class="badge yellow">json=bad</span>
                    {% else %}
                    <span class="badge">no-llm</span>
                    {% endif %}
                </td>
                <td class="text-wrap" style="font-size:0.8rem; color:var(--text-muted); max-width:260px;">{{ row.error_text or '' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align:center; padding:24px; color:var(--text-muted);">
                    –©–µ –Ω–µ–º–∞—î –∑–∞–ø—É—Å–∫—ñ–≤ extractor-–∞ –¥–ª—è –ø–∞–º'—è—Ç—ñ –ø–µ—Ä—Å–æ–Ω–∏.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2 style="margin-top: 32px;">üßæ –û—Å—Ç–∞–Ω–Ω—ñ –∫–∞–Ω–¥–∏–¥–∞—Ç–∏ —Ñ–∞–∫—Ç—ñ–≤ –ø–µ—Ä—Å–æ–Ω–∏</h2>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>–§–∞–∫—Ç</th>
                <th>–ó–Ω–∞—á–µ–Ω–Ω—è</th>
                <th>Meta</th>
                <th>–ú–æ–¥–µ—Ä–∞—Ü—ñ—è</th>
                <th>–ó–∞–ø–∏—Å</th>
            </tr>
        </thead>
        <tbody>
            {% for row in recent_candidates %}
            <tr>
                <td style="font-size:0.85rem; color:var(--text-muted);">{{ row.created_at|kyiv_time(default='–Ω/–¥') }}</td>
                <td>
                    <span class="badge">{{ row.fact_key }}</span>
                    <div style="margin-top:4px; font-size:0.78rem; color:var(--text-muted);">{{ row.fact_type or '' }}</div>
                </td>
                <td class="text-wrap">
                    {{ row.fact_value }}
                    {% if row.evidence_quote %}
                    <div style="margin-top:4px; font-size:0.78rem; color:var(--text-muted); max-width:260px;">
                        "{{ row.evidence_quote }}"
                    </div>
                    {% endif %}
                </td>
                <td>
                    <div class="badge blue" style="margin:2px 4px 2px 0;">{{ row.about_target or 'assistant_self' }}</div>
                    <div class="badge" style="margin:2px 4px 2px 0;">{{ row.directness or 'explicit' }}</div>
                    <div style="font-size:0.78rem; color:var(--text-muted); margin-top:4px;">
                        conf={{ "%.2f"|format(row.confidence or 0) }}, imp={{ "%.2f"|format(row.importance or 0) }}
                    </div>
                </td>
                <td>
                    {% set action = row.moderation_action or 'accept' %}
                    <span class="badge {% if action == 'accept' %}green{% else %}yellow{% endif %}">{{ action }}</span>
                    <div class="text-wrap" style="font-size:0.78rem; color:var(--text-muted); margin-top:4px; max-width:220px;">
                        {{ row.moderation_reason or '' }}
                    </div>
                </td>
                <td>
                    {% if row.saved_to_memory %}
                    <span class="badge green">–∑–±–µ—Ä–µ–∂–µ–Ω–æ</span>
                    {% elif row.selected_for_apply %}
                    <span class="badge blue">–≤—ñ–¥—ñ–±—Ä–∞–Ω–æ</span>
                    {% else %}
                    <span class="badge">–Ω—ñ</span>
                    {% endif %}
                    {% if row.dry_run %}
                    <div style="margin-top:4px;"><span class="badge yellow">dry-run</span></div>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" style="text-align:center; padding:24px; color:var(--text-muted);">
                    –ö–∞–Ω–¥–∏–¥–∞—Ç—ñ–≤ —Ñ–∞–∫—Ç—ñ–≤ –ø–µ—Ä—Å–æ–Ω–∏ –ø–æ–∫–∏ –Ω–µ–º–∞—î.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
