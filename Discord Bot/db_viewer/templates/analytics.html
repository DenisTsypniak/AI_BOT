{% extends "base.html" %}

{% block title %}Аналітика - Live Role Bot{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Аналітика та Статистика</h1>
    <p class="page-description">Графіки активності та розподіл ролей.</p>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h2>Повідомлення по днях (Останні 30 днів)</h2>
    <div style="height: 300px; width: 100%;">
        <canvas id="dailyChart"></canvas>
    </div>
</div>

<div class="card">
    <h2>Розподіл за ролями</h2>
    <div style="height: 300px; width: 100%; max-width: 500px; margin: 0 auto;">
        <canvas id="roleChart"></canvas>
    </div>
</div>

<script id="analytics-data" type="application/json">
    {{ data|tojson|safe }}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dataElement = document.getElementById('analytics-data');
    let rawData = null;
    try {
        if (dataElement && dataElement.textContent) {
            rawData = JSON.parse(dataElement.textContent);
        }
    } catch (e) {
        console.error("Failed to parse analytics data", e);
    }

    if (rawData && rawData.daily_messages && rawData.daily_messages.length > 0) {
        const ctxDaily = document.getElementById('dailyChart').getContext('2d');
        const dates = rawData.daily_messages.map(d => d.date).reverse();
        const counts = rawData.daily_messages.map(d => d.count).reverse();

        new Chart(ctxDaily, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Кількість повідомлень',
                    data: counts,
                    borderColor: '#10a37f',
                    backgroundColor: 'rgba(16, 163, 127, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    if (rawData && rawData.role_distribution && rawData.role_distribution.length > 0) {
        const ctxRole = document.getElementById('roleChart').getContext('2d');
        const roles = rawData.role_distribution.map(d => d.role || 'Unknown');
        const roleCounts = rawData.role_distribution.map(d => d.count);

        new Chart(ctxRole, {
            type: 'doughnut',
            data: {
                labels: roles,
                datasets: [{
                    data: roleCounts,
                    backgroundColor: ['#10a37f', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
</script>
{% endblock %}