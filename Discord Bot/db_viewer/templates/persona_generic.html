{% extends "base.html" %}

{% block title %}{{ title }} - Live Role Bot{% endblock %}

{% block content %}
<div class="stack">
    <section class="page-header">
        <div class="split">
            <div>
                <h1 class="page-title">{{ title }}</h1>
                <p class="page-description">Технічний перегляд останніх записів таблиці персони.</p>
            </div>
            <a href="/persona" class="btn">← Назад</a>
        </div>
    </section>

    {% if error %}
    <section class="card" style="border-left: 4px solid rgba(239,68,68,.65); background: rgba(239,68,68,.08);">
        <h2 class="section-title" style="color:#ffb1b1;">Помилка завантаження даних</h2>
        <pre style="margin:0;">{{ error }}</pre>
    </section>
    {% endif %}

    <div class="table-container">
        <table style="white-space: nowrap;">
            <thead>
                <tr>
                    {% if rows %}
                    {% for col in rows[0].keys() %}
                    <th>{{ col }}</th>
                    {% endfor %}
                    {% else %}
                    <th>Дані</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    {% for col, val in row.items() %}
                    {% if loop.index0 == 0 and col.endswith('_id') %}
                    <td class="mono" style="color: var(--accent);">
                        {{ val }}
                        {% if can_view_detail %}
                        <a href="{{ endpoint }}/{{ val }}" class="btn primary" style="padding: 4px 8px; font-size: .72rem; margin-left: 8px;">Дет.</a>
                        {% endif %}
                    </td>
                    {% elif val is none %}
                    <td class="text-muted" style="font-style: italic;">NULL</td>
                    {% elif 'time' in col or 'date' in col or 'created_at' in col or 'updated_at' in col %}
                    <td class="text-muted" style="font-size: 0.84rem;">{{ val|kyiv_time('%Y-%m-%d %H:%M:%S', default=val) }}</td>
                    {% elif val is number %}
                    <td class="mono text-right" style="color: var(--accent);">{{ val }}</td>
                    {% elif val is string and (val.startswith('{') or val.startswith('[')) %}
                    <td><pre style="margin:0; max-height:200px; font-size:.8rem;">{{ val|json_pretty }}</pre></td>
                    {% elif val is string and val|length > 60 %}
                    <td title="{{ val }}">{{ val[:57] }}...</td>
                    {% else %}
                    <td style="max-width: 320px; overflow: hidden; text-overflow: ellipsis;">{{ val }}</td>
                    {% endif %}
                    {% endfor %}
                </tr>
                {% else %}
                <tr>
                    <td colspan="10"><div class="empty-state">Дані відсутні або таблиця ще не створена.</div></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        {% set prev_offset = offset - limit %}
        {% set next_offset = offset + limit %}

        {% if offset > 0 %}
        <a href="{{ endpoint }}?limit={{ limit }}&offset={{ prev_offset }}" class="btn">← Попередня</a>
        {% else %}
        <button class="btn" disabled>← Попередня</button>
        {% endif %}

        {% if rows|length == limit %}
        <a href="{{ endpoint }}?limit={{ limit }}&offset={{ next_offset }}" class="btn">Наступна →</a>
        {% else %}
        <button class="btn" disabled>Наступна →</button>
        {% endif %}
    </div>
</div>
{% endblock %}

